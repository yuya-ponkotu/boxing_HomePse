参考URL
https://pikawaka.com/rails/ec2_deploy#AMI%E3%82%92%E9%81%B8%E6%8A%9E%E3%81%97%E3%82%88%E3%81%86
======== IPが変わったら ===========
/etc/nginx/conf.d/rails.conf　の　server_nameのIPを変更

mariadbとnginxの起動を忘れずに
sudo systemctl start mariadb
sudo systemctl start nginx
=================================

sudo yum update

sudo yum -y install gcc-c++ make patch git curl zlib-devel openssl-devel ImageMagick-devel readline-devel libcurl-devel libffi-devel libicu-devel libxml2-devel libxslt-devel

# AWSのリポジトリに追加
curl -sL https://rpm.nodesource.com/setup_14.x | sudo bash -

#Node.jsをインストール
sudo yum -y install nodejs

# AWSのリポジトリに追加
curl -sL https://dl.yarnpkg.com/rpm/yarn.repo | sudo tee /etc/yum.repos.d/yarn.repo

#yarnもインストール
sudo yum -y install yarn

#rubyのバージョン管理ツールであるrbenvをインストール
#レポジトリをクローンしてインストール
git clone https://github.com/sstephenson/rbenv.git ~/.rbenv
#.bash_profileの設定
echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bash_profile
echo 'eval "$(rbenv init -)"' >> ~/.bash_profile
source .bash_profile

#rubyをインストールするためのruby-buildをインストール
git clone https://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build

# rubyのインストール使用中のバージョンを指定
rbenv install 2.7.5

# インストールしたrubyを使用可能にする
rbenv rehash

# このインスタンスで使用するバージョンの設定
rbenv global 2.7.5


#MariaDBとMySqlをインストール
sudo yum -y install mariadb-server mysql-devel

#データーベースを起動
sudo systemctl start mariadb

#rootパスワードなどのセキュリティ設定
#問いには全てy
sudo mysql_secure_installation

#mariaDBにrootで接続
mysql -u root -p


====== gitと連携 ============
#何か出たらenterキーを押す
ssh-keygen -t rsa

#「ssh-rsa」から最後の「.internal」まで全てコピー
#githubのマイアカウントのsettingから
#SSH and GPG keysから New SSH keyに行きペースト,ass ssh keyをクリック
cat ~/.ssh/id_rsa.pub

#ssh接続ができるかを確認
ssh -T git@github.com
==============================

#GitHubからクローンしてくるアプリの保存先を作成
sudo mkdir /var/www/
sudo chown ec2-user /var/www/

#Nginxをインストール
sudo amazon-linux-extras install nginx1
nginx -v


#nginxの設定ファイルを編集
sudo vi /etc/nginx/conf.d/rails.conf

#アプリのクローン
cd /var/www/
git clone リポジトリのURL

#bundlerをインストール
bundler -v     (ローカルのバージョンを確認)
cd レポジトリ名
gem install bundler -v バージョン
bundle install

======== bundle install　時のエラー ========
#gem 'pg', '1.1.4'をインストールできない時
sudo yum install postgresql
sudo yum install postgresql-devel

#sqlite-3をインストールできない時
sudo yum install sqlite-devel
============================================

#値をコピー
bundle exec rake secret

#EC2インスタンス内の環境変数は/etc/environmentというファイルで管理
sudo vi /etc/environment

DATABASE_PASSWORD='MariaDBのrootユーザーのパスワード'
SECRET_KEY_BASE='コピーしたsecret_key_baseの値'
RAILS_MASTER_KEY="config/master.keyファイルの中身"

#sshを一度入り直し環境変数が適用されているか確認
 env | grep DATABASE_PASSWORD
 env | grep SECRET_KEY_BASE

 #アセットファイルをコンパイル
 #クローンしたアプリのディレクトリに移動
 rails assets:precompile RAILS_ENV=production

config/database.ymlの本番環境の定義部分を下記のように編集
rails new時にデータベースをmysqlで指定してなかったらmysql用に編集し
Gemfileのproductionにmysql2 0.5.2を追加

 #データベースの作成
 rails db:create RAILS_ENV=production
 # テーブルの作成
 rails db:migrate RAILS_ENV=production

 #railsの起動
 #nginxを再起動後
 unicorn_rails -c config/unicorn.rb -E production -D
